name: Deploy Garmin Lambdas

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-2
  ACCOUNT_ID: "010438461793"
  LAYER_BUCKET: "aseaotter-lambda-requirements"

  PULL_FUNCTION_NAME: "garmin_pull"
  PUSH_FUNCTION_NAME: "garmin_push"

  PULL_LAYER_NAME: "garmin-pull-deps"
  PUSH_LAYER_NAME: "garmin-push-deps"

  PYTHON_RUNTIME: "python3.12"
  ARCH: "x86_64"

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::010438461793:role/garmin_push_pull_deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"  # match your Lambda runtime

      # ========= PULL LAYER (deps) =========
      - name: Build pull layer (deps)
        run: |
          rm -rf build
          mkdir -p build/pull_layer/python
          pip install -r garmin_pull/requirements.txt -t build/pull_layer/python
          cd build/pull_layer
          zip -r ../pull_layer.zip python

      - name: Upload pull layer to S3
        run: |
          PULL_LAYER_KEY="layers/pull_layer_${GITHUB_SHA}.zip"
          echo "PULL_LAYER_KEY=$PULL_LAYER_KEY" >> $GITHUB_ENV
          aws s3 cp build/pull_layer.zip "s3://${LAYER_BUCKET}/${PULL_LAYER_KEY}"

      - name: Publish pull layer version
        id: publish_pull_layer
        run: |
          LAYER_ARN=$(aws lambda publish-layer-version \
            --layer-name "${PULL_LAYER_NAME}" \
            --content "S3Bucket=${LAYER_BUCKET},S3Key=${PULL_LAYER_KEY}" \
            --compatible-runtimes "${PYTHON_RUNTIME}" \
            --compatible-architectures "${ARCH}" \
            --query 'LayerVersionArn' \
            --output text)
          echo "PULL_LAYER_ARN=$LAYER_ARN" >> $GITHUB_ENV
          echo "Published pull layer: $LAYER_ARN"

      - name: Attach pull layer to function
        run: |
          aws lambda update-function-configuration \
            --function-name "${PULL_FUNCTION_NAME}" \
            --layers "${PULL_LAYER_ARN}"

      # ========= PUSH LAYER (deps) =========
      - name: Build push layer (deps)
        run: |
          mkdir -p build/push_layer/python
          pip install -r garmin_push/requirements.txt -t build/push_layer/python
          cd build/push_layer
          zip -r ../push_layer.zip python

      - name: Upload push layer to S3
        run: |
          PUSH_LAYER_KEY="layers/push_layer_${GITHUB_SHA}.zip"
          echo "PUSH_LAYER_KEY=$PUSH_LAYER_KEY" >> $GITHUB_ENV
          aws s3 cp build/push_layer.zip "s3://${LAYER_BUCKET}/${PUSH_LAYER_KEY}"

      - name: Publish push layer version
        id: publish_push_layer
        run: |
          LAYER_ARN=$(aws lambda publish-layer-version \
            --layer-name "${PUSH_LAYER_NAME}" \
            --content "S3Bucket=${LAYER_BUCKET},S3Key=${PUSH_LAYER_KEY}" \
            --compatible-runtimes "${PYTHON_RUNTIME}" \
            --compatible-architectures "${ARCH}" \
            --query 'LayerVersionArn' \
            --output text)
          echo "PUSH_LAYER_ARN=$LAYER_ARN" >> $GITHUB_ENV
          echo "Published push layer: $LAYER_ARN"

      - name: Attach push layer to function
        run: |
          aws lambda update-function-configuration \
            --function-name "${PUSH_FUNCTION_NAME}" \
            --layers "${PUSH_LAYER_ARN}"

      # ========= PULL CODE (small zip) =========
      - name: Build pull code zip
        run: |
          mkdir -p build/pull_code
          cp garmin_pull/pull.py build/pull_code/
          if [ -d garmin_pull/python ]; then
            cp -r garmin_pull/python build/pull_code/
          fi
          cd build/pull_code
          zip -r ../pull_code.zip .

      - name: Deploy pull code
        run: |
          aws lambda update-function-code \
            --function-name "${PULL_FUNCTION_NAME}" \
            --zip-file fileb://build/pull_code.zip

      # ========= PUSH CODE (small zip) =========
      - name: Build push code zip
        run: |
          # Start clean
          rm -rf build/push_code
          mkdir -p build/push_code

          # Copy ONLY the code you need in the function package
          cp garmin_push/push.py build/push_code/

          # If you have tiny helper modules, copy them explicitly:
          # cp garmin_push/helpers.py build/push_code/

          cd build/push_code

          # Zip ONLY the contents of this directory, not the whole build tree
          zip -r ../push_code.zip .

          cd -
          echo "Size of push_code.zip:"
          ls -lh build/push_code.zip
          echo "First few files inside push_code.zip:"
          unzip -l build/push_code.zip | head -40

      - name: Deploy push code
        run: |
          aws lambda update-function-code \
            --function-name "${PUSH_FUNCTION_NAME}" \
            --zip-file fileb://build/push_code.zip


